<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>照片PDF转换工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        accent: '#f59e0b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-soft': 'pulseSoft 2s infinite',
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .glass-effect {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .gradient-bg {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            .card-shadow {
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulseSoft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .image-preview {
            transition: all 0.3s ease;
        }
        
        .image-preview:hover {
            transform: scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        .drop-zone {
            transition: all 0.3s ease;
        }
        
        .drop-zone.drag-over {
            background-color: rgba(37, 99, 235, 0.1);
            border-color: #2563eb;
            transform: translateY(-2px);
        }
    </style>
</head>

<body class="font-inter bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
    <!-- 顶部导航 -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-gray-200/50 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fa fa-file-pdf-o text-white text-lg"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900">照片PDF转换工具</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fa fa-moon-o text-gray-600"></i>
                    </button>
                    <button id="helpBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fa fa-question-circle text-gray-600"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 功能说明卡片 -->
        <div class="bg-white rounded-2xl card-shadow p-6 mb-8 animate-fade-in">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">强大的PDF图片处理工具</h2>
                <p class="text-gray-600">在浏览器中轻松转换PDF与图片，支持压缩质量调整和实时预览</p>
            </div>
            
            <div class="grid md:grid-cols-3 gap-6">
                <div class="text-center p-4 rounded-xl bg-blue-50">
                    <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center mx-auto mb-3">
                        <i class="fa fa-upload text-white text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-2">上传PDF</h3>
                    <p class="text-sm text-gray-600">支持拖放上传，快速加载PDF文件</p>
                </div>
                
                <div class="text-center p-4 rounded-xl bg-green-50">
                    <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center mx-auto mb-3">
                        <i class="fa fa-compress text-white text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-2">调整质量</h3>
                    <p class="text-sm text-gray-600">自定义压缩参数，平衡质量与大小</p>
                </div>
                
                <div class="text-center p-4 rounded-xl bg-purple-50">
                    <div class="w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center mx-auto mb-3">
                        <i class="fa fa-download text-white text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-2">下载保存</h3>
                    <p class="text-sm text-gray-600">实时预览效果，一键下载图片</p>
                </div>
            </div>
        </div>

        <!-- 上传区域 -->
        <div class="bg-white rounded-2xl card-shadow p-8 mb-8 animate-slide-up">
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-gray-900 mb-2">上传PDF文件</h3>
                <p class="text-gray-600">支持PDF格式，最大20MB</p>
            </div>
            
            <!-- 拖放区域 -->
            <div id="dropZone" class="drop-zone border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-blue-500 transition-all cursor-pointer mb-6">
                <div class="space-y-4">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto">
                        <i class="fa fa-cloud-upload text-blue-500 text-2xl"></i>
                    </div>
                    <p class="text-gray-700 font-medium">拖放PDF文件到这里</p>
                    <p class="text-gray-500 text-sm">或者</p>
                    <button id="browseBtn" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium">
                        <i class="fa fa-file-pdf-o mr-2"></i>选择PDF文件
                    </button>
                    <input type="file" id="fileInput" accept=".pdf" class="hidden">
                </div>
            </div>
            
            <!-- 文件信息 -->
            <div id="fileInfo" class="hidden bg-gray-50 rounded-xl p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fa fa-file-pdf-o text-red-500 text-xl"></i>
                        <div>
                            <p id="fileName" class="font-medium text-gray-900"></p>
                            <p id="fileSize" class="text-sm text-gray-600"></p>
                        </div>
                    </div>
                    <button id="removeFile" class="text-gray-400 hover:text-red-500 transition-colors">
                        <i class="fa fa-times-circle text-lg"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 压缩设置 -->
        <div id="compressionSettings" class="bg-white rounded-2xl card-shadow p-8 mb-8 hidden animate-slide-up">
            <h3 class="text-xl font-bold text-gray-900 mb-6">压缩质量设置</h3>
            
            <div class="grid md:grid-cols-2 gap-8">
                <!-- 质量滑块 -->
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-gray-700">
                        <i class="fa fa-bullseye mr-2 text-accent"></i>图片质量
                    </label>
                    <div class="space-y-2">
                        <input type="range" id="qualitySlider" min="0.1" max="1" step="0.1" value="0.7" 
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>低质量</span>
                            <span id="qualityValue" class="font-medium text-accent">70%</span>
                            <span>高质量</span>
                        </div>
                    </div>
                </div>
                
                <!-- 格式选择 -->
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-gray-700">
                        <i class="fa fa-image mr-2 text-accent"></i>输出格式
                    </label>
                    <select id="formatSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="image/jpeg">JPEG (推荐照片)</option>
                        <option value="image/png">PNG (无损质量)</option>
                        <option value="image/webp">WebP (最佳压缩)</option>
                    </select>
                </div>
                
                <!-- 分辨率设置 -->
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-gray-700">
                        <i class="fa fa-expand mr-2 text-accent"></i>分辨率缩放
                    </label>
                    <div class="space-y-2">
                        <input type="range" id="scaleSlider" min="0.25" max="2" step="0.25" value="1" 
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>25%</span>
                            <span id="scaleValue" class="font-medium text-accent">100%</span>
                            <span>200%</span>
                        </div>
                    </div>
                </div>
                
                <!-- 颜色模式 -->
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-gray-700">
                        <i class="fa fa-adjust mr-2 text-accent"></i>颜色模式
                    </label>
                    <select id="colorMode" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="color">彩色</option>
                        <option value="grayscale">灰度</option>
                        <option value="blackwhite">黑白</option>
                    </select>
                </div>
            </div>
            
            <!-- 开始转换按钮 -->
            <div class="mt-8 text-center">
                <button id="startConversion" class="bg-gradient-to-r from-primary to-blue-600 text-white px-8 py-3 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all font-medium shadow-lg hover:shadow-xl transform hover:scale-105">
                    <i class="fa fa-magic mr-2"></i>开始转换
                </button>
            </div>
        </div>

        <!-- 转换进度 -->
        <div id="conversionProgress" class="bg-white rounded-2xl card-shadow p-8 mb-8 hidden animate-slide-up">
            <h3 class="text-xl font-bold text-gray-900 mb-6">转换进度</h3>
            
            <div class="space-y-4">
                <div class="flex justify-between text-sm text-gray-600">
                    <span id="currentPageInfo">第 1 页 / 共 0 页</span>
                    <span id="progressPercentage">0%</span>
                </div>
                
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progressBar" class="progress-bar bg-gradient-to-r from-primary to-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                
                <div id="conversionStatus" class="text-center text-gray-600">
                    <i class="fa fa-spinner fa-spin mr-2"></i>正在准备转换...
                </div>
            </div>
        </div>

        <!-- 预览区域 -->
        <div id="previewSection" class="bg-white rounded-2xl card-shadow p-8 mb-8 hidden animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">转换结果预览</h3>
                <div class="flex space-x-3">
                    <button id="downloadAll" class="bg-success text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors font-medium">
                        <i class="fa fa-download mr-2"></i>下载全部
                    </button>
                    <button id="downloadPDF" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium">
                        <i class="fa fa-file-pdf-o mr-2"></i>保存为PDF
                    </button>
                </div>
            </div>
            
            <!-- 统计信息 -->
            <div id="statistics" class="bg-gray-50 rounded-xl p-4 mb-6">
                <div class="grid md:grid-cols-4 gap-4 text-center">
                    <div>
                        <p class="text-2xl font-bold text-primary" id="totalPages">0</p>
                        <p class="text-sm text-gray-600">总页数</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-success" id="totalSize">0 MB</p>
                        <p class="text-sm text-gray-600">总大小</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-accent" id="avgSize">0 KB</p>
                        <p class="text-sm text-gray-600">平均每页</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-purple-600" id="compressionRatio">0%</p>
                        <p class="text-sm text-gray-600">压缩率</p>
                    </div>
                </div>
            </div>
            
            <!-- 图片网格 -->
            <div id="imageGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 图片预览将在这里动态生成 -->
            </div>
        </div>
    </main>

    <!-- 帮助模态框 -->
    <div id="helpModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto m-4 animate-slide-up">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">使用帮助</h3>
                    <button id="closeHelp" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">1. 上传PDF文件</h4>
                    <p class="text-gray-600">您可以拖放PDF文件到上传区域，或者点击"选择PDF文件"按钮来上传文件。支持最大20MB的PDF文件。</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">2. 调整压缩设置</h4>
                    <ul class="text-gray-600 space-y-1">
                        <li>• <strong>图片质量</strong>：调整JPEG压缩质量，值越高质量越好但文件越大</li>
                        <li>• <strong>输出格式</strong>：选择JPEG、PNG或WebP格式</li>
                        <li>• <strong>分辨率缩放</strong>：调整图片的分辨率大小</li>
                        <li>• <strong>颜色模式</strong>：选择彩色、灰度或黑白模式</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">3. 开始转换</h4>
                    <p class="text-gray-600">点击"开始转换"按钮，系统将在浏览器中处理您的PDF文件，不会上传到任何服务器。</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">4. 下载结果</h4>
                    <p class="text-gray-600">转换完成后，您可以预览所有图片，并选择下载单张图片、下载全部图片或保存为PDF文件。</p>
                </div>
                
                <div class="bg-blue-50 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-900 mb-2">隐私说明</h4>
                    <p class="text-blue-700 text-sm">所有文件处理都在您的浏览器中进行，不会上传到任何服务器，确保您的文件安全和隐私。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载中模态框 -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 text-center animate-slide-up">
            <div class="w-16 h-16 border-4 border-gray-200 border-t-primary rounded-full animate-spin mx-auto mb-4"></div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">处理中...</h3>
            <p id="loadingMessage" class="text-gray-600">正在准备转换您的PDF文件</p>
        </div>
    </div>

    <script>
        class PDFImageConverter {
            constructor() {
                this.pdfDoc = null;
                this.selectedFile = null;
                this.convertedImages = [];
                this.originalSize = 0;
                this.compressedSize = 0;
                
                this.initializeElements();
                this.bindEvents();
                this.initializePDFJS();
            }
            
            initializeElements() {
                // 上传相关
                this.dropZone = document.getElementById('dropZone');
                this.browseBtn = document.getElementById('browseBtn');
                this.fileInput = document.getElementById('fileInput');
                this.fileInfo = document.getElementById('fileInfo');
                this.fileName = document.getElementById('fileName');
                this.fileSize = document.getElementById('fileSize');
                this.removeFile = document.getElementById('removeFile');
                
                // 压缩设置
                this.compressionSettings = document.getElementById('compressionSettings');
                this.qualitySlider = document.getElementById('qualitySlider');
                this.qualityValue = document.getElementById('qualityValue');
                this.formatSelect = document.getElementById('formatSelect');
                this.scaleSlider = document.getElementById('scaleSlider');
                this.scaleValue = document.getElementById('scaleValue');
                this.colorMode = document.getElementById('colorMode');
                this.startConversion = document.getElementById('startConversion');
                
                // 进度相关
                this.conversionProgress = document.getElementById('conversionProgress');
                this.currentPageInfo = document.getElementById('currentPageInfo');
                this.progressPercentage = document.getElementById('progressPercentage');
                this.progressBar = document.getElementById('progressBar');
                this.conversionStatus = document.getElementById('conversionStatus');
                
                // 预览相关
                this.previewSection = document.getElementById('previewSection');
                this.downloadAll = document.getElementById('downloadAll');
                this.downloadPDF = document.getElementById('downloadPDF');
                this.statistics = document.getElementById('statistics');
                this.totalPages = document.getElementById('totalPages');
                this.totalSize = document.getElementById('totalSize');
                this.avgSize = document.getElementById('avgSize');
                this.compressionRatio = document.getElementById('compressionRatio');
                this.imageGrid = document.getElementById('imageGrid');
                
                // 模态框
                this.helpBtn = document.getElementById('helpBtn');
                this.helpModal = document.getElementById('helpModal');
                this.closeHelp = document.getElementById('closeHelp');
                this.loadingModal = document.getElementById('loadingModal');
                this.loadingMessage = document.getElementById('loadingMessage');
            }
            
            bindEvents() {
                // 上传事件
                this.browseBtn.addEventListener('click', () => this.fileInput.click());
                this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                this.removeFile.addEventListener('click', () => this.clearFile());
                
                // 拖放事件
                this.dropZone.addEventListener('dragover', (e) => this.handleDragOver(e));
                this.dropZone.addEventListener('drop', (e) => this.handleDrop(e));
                this.dropZone.addEventListener('dragleave', () => this.handleDragLeave());
                
                // 压缩设置事件
                this.qualitySlider.addEventListener('input', (e) => this.updateQualityValue(e));
                this.scaleSlider.addEventListener('input', (e) => this.updateScaleValue(e));
                this.startConversion.addEventListener('click', () => this.startConvert());
                
                // 下载事件
                this.downloadAll.addEventListener('click', () => this.downloadAllImages());
                this.downloadPDF.addEventListener('click', () => this.convertImagesToPDF());
                
                // 模态框事件
                this.helpBtn.addEventListener('click', () => this.showHelp());
                this.closeHelp.addEventListener('click', () => this.hideHelp());
                this.helpModal.addEventListener('click', (e) => this.handleModalClick(e));
            }
            
            initializePDFJS() {
                // 设置PDF.js的worker路径
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            
            handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                this.dropZone.classList.add('drag-over');
            }
            
            handleDragLeave() {
                this.dropZone.classList.remove('drag-over');
            }
            
            handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                this.dropZone.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    this.handleFile(file);
                }
            }
            
            handleFileSelect(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    this.handleFile(file);
                }
            }
            
            handleFile(file) {
                if (file.type !== 'application/pdf') {
                    this.showNotification('请选择PDF文件', 'error');
                    return;
                }
                
                if (file.size > 20 * 1024 * 1024) { // 20MB
                    this.showNotification('文件大小不能超过20MB', 'error');
                    return;
                }
                
                this.selectedFile = file;
                this.originalSize = file.size;
                
                this.showFileInfo(file);
                this.showCompressionSettings();
            }
            
            showFileInfo(file) {
                this.fileName.textContent = file.name;
                this.fileSize.textContent = this.formatFileSize(file.size);
                this.fileInfo.classList.remove('hidden');
                this.dropZone.style.opacity = '0.7';
            }
            
            clearFile() {
                this.selectedFile = null;
                this.pdfDoc = null;
                this.convertedImages = [];
                this.originalSize = 0;
                this.compressedSize = 0;
                
                this.fileInput.value = '';
                this.fileInfo.classList.add('hidden');
                this.dropZone.style.opacity = '1';
                this.compressionSettings.classList.add('hidden');
                this.conversionProgress.classList.add('hidden');
                this.previewSection.classList.add('hidden');
            }
            
            showCompressionSettings() {
                this.compressionSettings.classList.remove('hidden');
                // 平滑滚动到设置区域
                this.compressionSettings.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            updateQualityValue(e) {
                const value = parseFloat(e.target.value);
                this.qualityValue.textContent = Math.round(value * 100) + '%';
            }
            
            updateScaleValue(e) {
                const value = parseFloat(e.target.value);
                this.scaleValue.textContent = Math.round(value * 100) + '%';
            }
            
            async startConvert() {
                if (!this.selectedFile) return;
                
                this.showLoading('正在加载PDF文件...');
                
                try {
                    // 读取PDF文件
                    const arrayBuffer = await this.readFileAsArrayBuffer(this.selectedFile);
                    this.pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    this.hideLoading();
                    this.showConversionProgress();
                    await this.convertPDFToImages();
                    
                } catch (error) {
                    this.hideLoading();
                    console.error('转换失败:', error);
                    this.showNotification('PDF文件解析失败，请检查文件是否损坏', 'error');
                }
            }
            
            readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }
            
            showConversionProgress() {
                this.conversionProgress.classList.remove('hidden');
                this.conversionProgress.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            async convertPDFToImages() {
                this.convertedImages = [];
                this.compressedSize = 0;
                
                const totalPages = this.pdfDoc.numPages;
                const quality = parseFloat(this.qualitySlider.value);
                const format = this.formatSelect.value;
                const scale = parseFloat(this.scaleSlider.value);
                const colorMode = this.colorMode.value;
                
                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                    try {
                        this.updateProgress(pageNum, totalPages, `正在转换第 ${pageNum} 页...`);
                        
                        const page = await this.pdfDoc.getPage(pageNum);
                        const viewport = page.getViewport({ scale: scale });
                        
                        // 创建canvas
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        // 渲染页面
                        const renderContext = {
                            canvasContext: context,
                            viewport: viewport
                        };
                        
                        await page.render(renderContext).promise;
                        
                        // 应用颜色模式
                        this.applyColorMode(canvas, context, colorMode);
                        
                        // 压缩图片
                        const compressedImage = await this.compressImage(canvas, format, quality);
                        this.convertedImages.push(compressedImage);
                        this.compressedSize += compressedImage.size;
                        
                        // 给UI线程一点时间更新
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } catch (error) {
                        console.error(`转换第 ${pageNum} 页失败:`, error);
                        this.showNotification(`第 ${pageNum} 页转换失败`, 'warning');
                    }
                }
                
                this.updateProgress(totalPages, totalPages, '转换完成！');
                await new Promise(resolve => setTimeout(resolve, 500));
                this.showPreview();
            }
            
            applyColorMode(canvas, context, mode) {
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                switch (mode) {
                    case 'grayscale':
                        for (let i = 0; i < data.length; i += 4) {
                            const gray = (data[i] * 0.3 + data[i + 1] * 0.59 + data[i + 2] * 0.11) | 0;
                            data[i] = gray;
                            data[i + 1] = gray;
                            data[i + 2] = gray;
                        }
                        context.putImageData(imageData, 0, 0);
                        break;
                        
                    case 'blackwhite':
                        for (let i = 0; i < data.length; i += 4) {
                            const gray = (data[i] * 0.3 + data[i + 1] * 0.59 + data[i + 2] * 0.11) | 0;
                            const bw = gray > 128 ? 255 : 0;
                            data[i] = bw;
                            data[i + 1] = bw;
                            data[i + 2] = bw;
                        }
                        context.putImageData(imageData, 0, 0);
                        break;
                }
            }
            
            compressImage(canvas, format, quality) {
                return new Promise((resolve) => {
                    canvas.toBlob((blob) => {
                        const fileType = format === 'image/jpeg' ? 'jpg' : format.split('/')[1];
                        const fileName = `page-${this.convertedImages.length + 1}.${fileType}`;
                        
                        resolve({
                            blob: blob,
                            url: URL.createObjectURL(blob),
                            size: blob.size,
                            fileName: fileName,
                            width: canvas.width,
                            height: canvas.height
                        });
                    }, format, quality);
                });
            }
            
            updateProgress(current, total, status) {
                const percentage = Math.round((current / total) * 100);
                this.currentPageInfo.textContent = `第 ${current} 页 / 共 ${total} 页`;
                this.progressPercentage.textContent = percentage + '%';
                this.progressBar.style.width = percentage + '%';
                this.conversionStatus.innerHTML = `<i class="fa fa-spinner fa-spin mr-2"></i>${status}`;
            }
            
            showPreview() {
                this.conversionProgress.classList.add('hidden');
                this.previewSection.classList.remove('hidden');
                this.previewSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                this.updateStatistics();
                this.renderImageGrid();
            }
            
            updateStatistics() {
                const totalPages = this.convertedImages.length;
                const totalSizeMB = (this.compressedSize / (1024 * 1024)).toFixed(2);
                const avgSizeKB = totalPages > 0 ? (this.compressedSize / totalPages / 1024).toFixed(1) : '0';
                const compressionRatio = this.originalSize > 0 ? 
                    Math.round((1 - this.compressedSize / this.originalSize) * 100) : 0;
                
                this.totalPages.textContent = totalPages;
                this.totalSize.textContent = totalSizeMB + ' MB';
                this.avgSize.textContent = avgSizeKB + ' KB';
                this.compressionRatio.textContent = compressionRatio + '%';
            }
            
            renderImageGrid() {
                this.imageGrid.innerHTML = '';
                
                this.convertedImages.forEach((image, index) => {
                    const imageCard = document.createElement('div');
                    imageCard.className = 'bg-gray-50 rounded-xl overflow-hidden shadow-lg image-preview';
                    
                    imageCard.innerHTML = `
                        <div class="relative">
                            <img src="${image.url}" alt="第 ${index + 1} 页" 
                                 class="w-full h-48 object-contain bg-white">
                            <div class="absolute top-2 right-2 flex space-x-1">
                                <button onclick="converter.downloadImage(${index})" 
                                        class="bg-white/80 hover:bg-white p-2 rounded-lg shadow-md transition-all">
                                    <i class="fa fa-download text-primary"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-4">
                            <h4 class="font-medium text-gray-900 mb-1">第 ${index + 1} 页</h4>
                            <p class="text-sm text-gray-600 mb-2">${image.width} × ${image.height}</p>
                            <p class="text-sm text-gray-500">${(image.size / 1024).toFixed(1)} KB</p>
                        </div>
                    `;
                    
                    this.imageGrid.appendChild(imageCard);
                });
            }
            
            downloadImage(index) {
                const image = this.convertedImages[index];
                saveAs(image.blob, image.fileName);
                this.showNotification('图片下载成功', 'success');
            }
            
            async downloadAllImages() {
                if (this.convertedImages.length === 0) return;
                
                this.showLoading('正在准备下载...');
                
                try {
                    // 创建ZIP文件（简化版，实际项目中可使用jszip库）
                    if (this.convertedImages.length === 1) {
                        // 单张图片直接下载
                        this.downloadImage(0);
                    } else {
                        // 多张图片打包下载（这里使用简单的方法，实际需要zip库）
                        this.convertedImages.forEach((image, index) => {
                            setTimeout(() => {
                                this.downloadImage(index);
                            }, index * 100);
                        });
                    }
                    
                    this.hideLoading();
                    this.showNotification('开始下载所有图片', 'success');
                    
                } catch (error) {
                    this.hideLoading();
                    this.showNotification('下载失败', 'error');
                }
            }
            
            async convertImagesToPDF() {
                if (this.convertedImages.length === 0) return;
                
                this.showLoading('正在生成PDF...');
                
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'px',
                        format: 'a4'
                    });
                    
                    for (let i = 0; i < this.convertedImages.length; i++) {
                        if (i > 0) {
                            pdf.addPage();
                        }
                        
                        const image = this.convertedImages[i];
                        const imgData = await this.getImageData(image.url);
                        
                        // 计算合适的尺寸
                        const a4Width = 595;
                        const a4Height = 842;
                        const aspectRatio = image.width / image.height;
                        
                        let width = a4Width - 40;
                        let height = width / aspectRatio;
                        
                        if (height > a4Height - 40) {
                            height = a4Height - 40;
                            width = height * aspectRatio;
                        }
                        
                        const x = (a4Width - width) / 2;
                        const y = (a4Height - height) / 2;
                        
                        pdf.addImage(imgData, 'JPEG', x, y, width, height);
                    }
                    
                    const pdfBlob = pdf.output('blob');
                    const timestamp = new Date().toISOString().replace(/[-:\.T]/g, '').substring(0, 14);
                    saveAs(pdfBlob, `converted_${timestamp}.pdf`);
                    
                    this.hideLoading();
                    this.showNotification('PDF生成成功', 'success');
                    
                } catch (error) {
                    this.hideLoading();
                    console.error('PDF生成失败:', error);
                    this.showNotification('PDF生成失败', 'error');
                }
            }
            
            getImageData(url) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        resolve(canvas.toDataURL('image/jpeg', 0.95));
                    };
                    img.onerror = reject;
                    img.src = url;
                });
            }
            
            showLoading(message) {
                this.loadingMessage.textContent = message || '处理中...';
                this.loadingModal.classList.remove('hidden');
                this.loadingModal.classList.add('flex');
            }
            
            hideLoading() {
                this.loadingModal.classList.add('hidden');
                this.loadingModal.classList.remove('flex');
            }
            
            showHelp() {
                this.helpModal.classList.remove('hidden');
                this.helpModal.classList.add('flex');
            }
            
            hideHelp() {
                this.helpModal.classList.add('hidden');
                this.helpModal.classList.remove('flex');
            }
            
            handleModalClick(e) {
                if (e.target === this.helpModal) {
                    this.hideHelp();
                }
            }
            
            showNotification(message, type = 'info') {
                // 创建通知元素
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
                
                // 根据类型设置样式
                switch (type) {
                    case 'success':
                        notification.classList.add('bg-success', 'text-white');
                        notification.innerHTML = `<i class="fa fa-check-circle mr-2"></i>${message}`;
                        break;
                    case 'error':
                        notification.classList.add('bg-danger', 'text-white');
                        notification.innerHTML = `<i class="fa fa-times-circle mr-2"></i>${message}`;
                        break;
                    case 'warning':
                        notification.classList.add('bg-warning', 'text-white');
                        notification.innerHTML = `<i class="fa fa-exclamation-triangle mr-2"></i>${message}`;
                        break;
                    default:
                        notification.classList.add('bg-primary', 'text-white');
                        notification.innerHTML = `<i class="fa fa-info-circle mr-2"></i>${message}`;
                }
                
                document.body.appendChild(notification);
                
                // 显示通知
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 100);
                
                // 自动隐藏
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        }
        
        // 初始化应用
        let converter;
        document.addEventListener('DOMContentLoaded', () => {
            converter = new PDFImageConverter();
        });
    </script>
</body>
</html>